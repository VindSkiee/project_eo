generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
// (Enum tetap sama seperti sebelumnya)
enum EventStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  REJECTED
  APPROVED
  CANCELLED
  FUNDED
  ONGOING
  COMPLETED
  SETTLED
}

enum TransactionType {
  DEBIT
  CREDIT
}

enum SystemRoleType {
  RESIDENT
  ADMIN
  TREASURER
  LEADER
  CUSTOM
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventParticipantRole {
  COMMITTEE
  ATTENDEE
  GUEST
}

enum FundRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentGatewayStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  REFUNDED
  CANCELLED
}

enum PaymentMethodCategory {
  VIRTUAL_ACCOUNT
  E_WALLET
  QRIS
  CREDIT_CARD
  CONVENIENCE_STORE
  MANUAL_TRANSFER
}

// --- CORE SYSTEM & RBAC ---

model Role {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  type          SystemRoleType @default(RESIDENT)
  description   String?
  users         User[]
  approvalRules ApprovalRule[]
  createdAt     DateTime       @default(now())
}

model CommunityGroup {
  id        Int    @id @default(autoincrement())
  name      String
  type      String // 'RT' atau 'RW'
  parentId  Int?
  
  parent   CommunityGroup?  @relation("GroupHierarchy", fields: [parentId], references: [id])
  children CommunityGroup[] @relation("GroupHierarchy")

  users                User[]
  events               Event[]
  wallet               Wallet?
  approvalRules        ApprovalRule[]
  fundRequestsSent     FundRequest[] @relation("FundRequester")
  fundRequestsReceived FundRequest[] @relation("FundTarget")
  duesRule             DuesRule?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ⚡ INDEX: Mempercepat query hierarki (Mencari anak buah RW tertentu)
  @@index([parentId]) 
}

model User {
  id               String         @id @default(uuid())
  email            String         @unique
  password         String
  fullName         String
  phone            String?
  address          String?
  isActive         Boolean        @default(true)
  
  roleId           Int
  role             Role           @relation(fields: [roleId], references: [id])
  
  communityGroupId Int
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)

  createdById  String?
  createdBy    User?   @relation("UserCreator", fields: [createdById], references: [id])
  createdUsers User[]  @relation("UserCreator")

  contributions        Contribution[]
  eventsCreated        Event[]              @relation("EventCreator")
  eventParticipations  EventParticipant[]
  approvalsGiven       EventApproval[]      @relation("ApproverUser")
  statusChanges        EventStatusHistory[] @relation("StatusChanger")
  paymentGatewayTxs    PaymentGatewayTx[]
  fundRequestsCreated  FundRequest[]        @relation("FundCreator")
  fundRequestsApproved FundRequest[]        @relation("FundApprover")
  transactions         Transaction[]

  lastPaidPeriod DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  // ⚡ INDEX:
  // 1. Mempercepat login & pencarian user per Group
  // 2. Mempercepat filter berdasarkan Role (Misal: Cari semua Bendahara)
  @@index([communityGroupId])
  @@index([roleId])
  @@index([email]) 
}

// --- FINANCE MODULE ---

model Wallet {
  id               Int            @id @default(autoincrement())
  balance          Decimal        @default(0) @db.Decimal(15, 2)
  communityGroupId Int            @unique
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
  transactions     Transaction[]
  updatedAt        DateTime       @updatedAt
}

model DuesRule {
  id               Int            @id @default(autoincrement())
  communityGroupId Int            @unique
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
  amount           Decimal        @db.Decimal(15, 2)
  dueDay           Int            @default(10)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model Contribution {
  id                 String            @id @default(uuid())
  userId             String
  user               User              @relation(fields: [userId], references: [id])
  amount             Decimal           @db.Decimal(15, 2)
  month              Int
  year               Int
  paidAt             DateTime          @default(now())
  transaction        Transaction?
  paymentGatewayTxId String?           @unique
  paymentGatewayTx   PaymentGatewayTx? @relation(fields: [paymentGatewayTxId], references: [id])
  createdAt          DateTime          @default(now())

  // ⚡ INDEX:
  // 1. Mempercepat history pembayaran User
  // 2. Mempercepat laporan bulanan (Cari semua pembayaran bulan X tahun Y)
  @@index([userId])
  @@index([month, year]) 
}

model Transaction {
  id            String          @id @default(uuid())
  walletId      Int
  wallet        Wallet          @relation(fields: [walletId], references: [id])
  amount        Decimal         @db.Decimal(15, 2)
  type          TransactionType
  description   String
  referenceCode String?
  createdById   String?
  createdBy     User?           @relation(fields: [createdById], references: [id])
  
  contributionId String?       @unique
  contribution   Contribution? @relation(fields: [contributionId], references: [id])
  
  eventId String?
  event   Event?  @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())

  // ⚡ INDEX PENTING (High Traffic Table):
  // 1. [walletId, createdAt]: Super cepat untuk "Infinite Scroll" history dompet
  // 2. [eventId]: Cepat cari pengeluaran event tertentu
  // 3. [type]: Cepat hitung total Debit vs Credit
  @@index([walletId, createdAt(sort: Desc)]) 
  @@index([eventId])
  @@index([type])
  @@index([createdById])
}

// --- EVENT MODULE ---

model Event {
  id               String         @id @default(uuid())
  title            String
  description      String         @db.Text
  status           EventStatus    @default(DRAFT)
  budgetEstimated  Decimal        @db.Decimal(15, 2)
  budgetActual     Decimal?       @db.Decimal(15, 2)
  startDate        DateTime?
  endDate          DateTime?
  
  communityGroupId Int
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
  
  createdById   String
  createdBy     User               @relation("EventCreator", fields: [createdById], references: [id])
  fundRequests  FundRequest[]
  approvals     EventApproval[]
  statusHistory EventStatusHistory[]
  participants  EventParticipant[]
  transactions  Transaction[]
  expenses      EventExpense[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ⚡ INDEX:
  // 1. Dashboard: Cari event berdasarkan Group dan Statusnya (Misal: Event Aktif di RT 01)
  // 2. Calendar: Cari event berdasarkan tanggal mulai
  @@index([communityGroupId, status])
  @@index([startDate])
  @@index([createdById])
}

model ApprovalRule {
  id               Int            @id @default(autoincrement())
  communityGroupId Int
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
  roleId           Int
  role             Role           @relation(fields: [roleId], references: [id])
  stepOrder        Int
  isMandatory      Boolean        @default(true)
  minAmount        Decimal?       @db.Decimal(15, 2)
  isCrossGroup     Boolean        @default(false)

  @@unique([communityGroupId, roleId, stepOrder])
  // ⚡ INDEX: Mempercepat pencarian rule saat event dibuat
  @@index([communityGroupId]) 
}

model EventApproval {
  id           String         @id @default(uuid())
  eventId      String
  event        Event          @relation(fields: [eventId], references: [id])
  approverId   String
  approver     User           @relation("ApproverUser", fields: [approverId], references: [id])
  roleSnapshot String
  stepOrder    Int
  status       ApprovalStatus
  notes        String?
  approvedAt   DateTime?
  createdAt    DateTime       @default(now())

  @@unique([eventId, approverId, stepOrder])
  // ⚡ INDEX: Mempercepat pengecekan status approval suatu event
  @@index([eventId]) 
}

model EventStatusHistory {
  id             String      @id @default(uuid())
  eventId        String
  event          Event       @relation(fields: [eventId], references: [id])
  changedById    String
  changedBy      User        @relation("StatusChanger", fields: [changedById], references: [id])
  previousStatus EventStatus
  newStatus      EventStatus
  reason         String?
  createdAt      DateTime    @default(now())

  // ⚡ INDEX: Audit trail sering di-query per event
  @@index([eventId])
}

model EventParticipant {
  id       Int                  @id @default(autoincrement())
  eventId  String
  event    Event                @relation(fields: [eventId], references: [id])
  userId   String
  user     User                 @relation(fields: [userId], references: [id])
  role     EventParticipantRole @default(ATTENDEE)
  joinedAt DateTime             @default(now())

  @@unique([eventId, userId])
  // ⚡ INDEX:
  // 1. Cek peserta event
  // 2. Cek user ini ikut event apa saja
  @@index([eventId])
  @@index([userId])
}

model EventExpense {
  id         String   @id @default(uuid())
  eventId    String
  event      Event    @relation(fields: [eventId], references: [id])
  title      String
  amount     Decimal  @db.Decimal(15, 2)
  proofImage String?
  verifiedBy String?
  isValid    Boolean  @default(false)
  createdAt  DateTime @default(now())

  // ⚡ INDEX: Rekap pengeluaran per event
  @@index([eventId])
}

// --- MIDTRANS & PAYMENT INTEGRATION ---

model PaymentGatewayTx {
  id             String                @id @default(uuid())
  orderId        String                @unique
  midtransId     String?               @unique
  amount         Decimal               @db.Decimal(15, 2)
  grossAmount    Decimal               @db.Decimal(15, 2)
  status         PaymentGatewayStatus  @default(PENDING)
  methodCategory PaymentMethodCategory
  providerCode   String?
  vaNumber       String?
  snapToken      String?
  redirectUrl    String?
  rawRequest     Json?
  rawResponse    Json?
  paidAt         DateTime?
  
  userId       String
  user         User          @relation(fields: [userId], references: [id])
  contribution Contribution?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ⚡ INDEX:
  // 1. Webhook processing (Cari by Order ID sudah unique, tapi status sering di-filter)
  // 2. History transaksi User
  // 3. Reporting harian (CreatedAt)
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model FundRequest {
  id               String            @id @default(uuid())
  requesterGroupId Int
  requesterGroup   CommunityGroup    @relation("FundRequester", fields: [requesterGroupId], references: [id], onDelete: Cascade)
  targetGroupId    Int
  targetGroup      CommunityGroup    @relation("FundTarget", fields: [targetGroupId], references: [id], onDelete: Cascade)
  amount           Decimal           @db.Decimal(15, 2)
  description      String            @db.Text
  status           FundRequestStatus @default(PENDING)
  
  eventId      String?
  event        Event? @relation(fields: [eventId], references: [id])
  createdById  String
  createdBy    User   @relation("FundCreator", fields: [createdById], references: [id])
  approvedById String?
  approvedBy   User?  @relation("FundApprover", fields: [approvedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ⚡ INDEX:
  // 1. Inbox RW (Melihat request masuk: targetGroup + status)
  // 2. Outbox RT (Melihat request terkirim: requesterGroup)
  @@index([targetGroupId, status])
  @@index([requesterGroupId])
}