generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  type          SystemRoleType @default(RESIDENT)
  description   String?
  createdAt     DateTime       @default(now())
  approvalRules ApprovalRule[]
  users         User[]
}

model CommunityGroup {
  id                   Int                @id @default(autoincrement())
  name                 String
  type                 String
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  parentId             Int?
  approvalRules        ApprovalRule[]
  parent               CommunityGroup?    @relation("GroupHierarchy", fields: [parentId], references: [id])
  children             CommunityGroup[]   @relation("GroupHierarchy")
  duesRule             DuesRule?
  events               Event[]
  fundRequestsSent     FundRequest[]      @relation("FundRequester")
  fundRequestsReceived FundRequest[]      @relation("FundTarget")
  roleLabelSettings    RoleLabelSetting[]
  users                User[]
  wallet               Wallet?

  @@index([parentId])
}

model User {
  id                   String               @id @default(uuid())
  email                String               @unique
  password             String
  fullName             String
  phone                String?
  address              String?
  roleId               Int
  communityGroupId     Int
  createdById          String?
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  deletedAt            DateTime?
  isActive             Boolean              @default(true)
  lastPaidPeriod       DateTime?
  profileImage         String?
  contributions        Contribution[]
  eventsCreated        Event[]              @relation("EventCreator")
  approvalsGiven       EventApproval[]      @relation("ApproverUser")
  eventParticipations  EventParticipant[]
  statusChanges        EventStatusHistory[] @relation("StatusChanger")
  fundRequestsApproved FundRequest[]        @relation("FundApprover")
  fundRequestsCreated  FundRequest[]        @relation("FundCreator")
  paymentGatewayTxs    PaymentGatewayTx[]
  transactions         Transaction[]
  communityGroup       CommunityGroup       @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
  createdBy            User?                @relation("UserCreator", fields: [createdById], references: [id])
  createdUsers         User[]               @relation("UserCreator")
  role                 Role                 @relation(fields: [roleId], references: [id])

  @@index([communityGroupId])
  @@index([roleId])
  @@index([email])
}

model Wallet {
  id               Int            @id @default(autoincrement())
  balance          Decimal        @default(0) @db.Decimal(15, 2)
  communityGroupId Int            @unique
  updatedAt        DateTime       @updatedAt
  transactions     Transaction[]
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
}

model DuesRule {
  id               Int            @id @default(autoincrement())
  communityGroupId Int            @unique
  amount           Decimal        @db.Decimal(15, 2)
  dueDay           Int            @default(10)
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
}

model Contribution {
  id                 String            @id @default(uuid())
  userId             String
  amount             Decimal           @db.Decimal(15, 2)
  month              Int
  year               Int
  paidAt             DateTime          @default(now())
  paymentGatewayTxId String?           @unique
  createdAt          DateTime          @default(now())
  paymentGatewayTx   PaymentGatewayTx? @relation(fields: [paymentGatewayTxId], references: [id])
  user               User              @relation(fields: [userId], references: [id])
  transaction        Transaction?

  @@index([userId])
  @@index([month, year])
}

model Transaction {
  id             String          @id @default(uuid())
  walletId       Int
  amount         Decimal         @db.Decimal(15, 2)
  type           TransactionType
  description    String
  referenceCode  String?
  contributionId String?         @unique
  eventId        String?
  createdAt      DateTime        @default(now())
  createdById    String?
  contribution   Contribution?   @relation(fields: [contributionId], references: [id])
  createdBy      User?           @relation(fields: [createdById], references: [id])
  event          Event?          @relation(fields: [eventId], references: [id])
  wallet         Wallet          @relation(fields: [walletId], references: [id])

  @@index([walletId, createdAt(sort: Desc)])
  @@index([eventId])
  @@index([type])
  @@index([createdById])
}

model Event {
  id                String               @id @default(uuid())
  title             String
  description       String
  status            EventStatus          @default(DRAFT)
  budgetEstimated   Decimal              @db.Decimal(15, 2)
  budgetActual      Decimal?             @db.Decimal(15, 2)
  startDate         DateTime?
  endDate           DateTime?
  receiptImages     String[]             @default([])
  resultImages      String[]             @default([])
  resultDescription String?
  communityGroupId  Int
  createdById       String
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  communityGroup    CommunityGroup       @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
  createdBy         User                 @relation("EventCreator", fields: [createdById], references: [id])
  approvals         EventApproval[]
  expenses          EventExpense[]
  participants      EventParticipant[]
  statusHistory     EventStatusHistory[]
  fundRequests      FundRequest[]
  transactions      Transaction[]

  @@index([communityGroupId, status])
  @@index([startDate])
  @@index([createdById])
}

model ApprovalRule {
  id               Int            @id @default(autoincrement())
  communityGroupId Int
  roleId           Int
  stepOrder        Int
  isMandatory      Boolean        @default(true)
  isCrossGroup     Boolean        @default(false)
  minAmount        Decimal?       @db.Decimal(15, 2)
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)
  role             Role           @relation(fields: [roleId], references: [id])

  @@unique([communityGroupId, roleId, stepOrder])
  @@index([communityGroupId])
}

model EventApproval {
  id           String         @id @default(uuid())
  eventId      String
  approverId   String
  roleSnapshot String
  stepOrder    Int
  status       ApprovalStatus
  notes        String?
  createdAt    DateTime       @default(now())
  approvedAt   DateTime?
  approver     User           @relation("ApproverUser", fields: [approverId], references: [id])
  event        Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, approverId, stepOrder])
  @@index([eventId])
}

model EventStatusHistory {
  id             String      @id @default(uuid())
  eventId        String
  changedById    String
  previousStatus EventStatus
  newStatus      EventStatus
  reason         String?
  createdAt      DateTime    @default(now())
  changedBy      User        @relation("StatusChanger", fields: [changedById], references: [id])
  event          Event       @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model EventParticipant {
  id       Int                  @id @default(autoincrement())
  eventId  String
  userId   String
  role     EventParticipantRole @default(ATTENDEE)
  joinedAt DateTime             @default(now())
  event    Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user     User                 @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model EventExpense {
  id         String   @id @default(uuid())
  eventId    String
  title      String
  amount     Decimal  @db.Decimal(15, 2)
  proofImage String?
  verifiedBy String?
  isValid    Boolean  @default(false)
  createdAt  DateTime @default(now())
  event      Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model PaymentGatewayTx {
  id             String                @id @default(uuid())
  orderId        String                @unique
  midtransId     String?               @unique
  amount         Decimal               @db.Decimal(15, 2)
  grossAmount    Decimal               @db.Decimal(15, 2)
  status         PaymentGatewayStatus  @default(PENDING)
  methodCategory PaymentMethodCategory
  providerCode   String?
  vaNumber       String?
  snapToken      String?
  redirectUrl    String?
  rawRequest     Json?
  rawResponse    Json?
  paidAt         DateTime?
  userId         String
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  contribution   Contribution?
  user           User                  @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model FundRequest {
  id               String            @id @default(uuid())
  requesterGroupId Int
  targetGroupId    Int
  amount           Decimal           @db.Decimal(15, 2)
  approvedAmount   Decimal?          @db.Decimal(15, 2)
  description      String
  notes            String?
  status           FundRequestStatus @default(PENDING)
  createdById      String
  approvedById     String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  eventId          String?
  approvedBy       User?             @relation("FundApprover", fields: [approvedById], references: [id])
  createdBy        User              @relation("FundCreator", fields: [createdById], references: [id])
  event            Event?            @relation(fields: [eventId], references: [id])
  requesterGroup   CommunityGroup    @relation("FundRequester", fields: [requesterGroupId], references: [id], onDelete: Cascade)
  targetGroup      CommunityGroup    @relation("FundTarget", fields: [targetGroupId], references: [id], onDelete: Cascade)

  @@index([targetGroupId, status])
  @@index([requesterGroupId])
}

model RoleLabelSetting {
  id               Int            @id @default(autoincrement())
  roleType         SystemRoleType
  label            String
  communityGroupId Int
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  communityGroup   CommunityGroup @relation(fields: [communityGroupId], references: [id], onDelete: Cascade)

  @@unique([roleType, communityGroupId])
  @@index([communityGroupId])
}

enum EventStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  REJECTED
  APPROVED
  FUNDED
  ONGOING
  COMPLETED
  SETTLED
  CANCELLED
}

enum TransactionType {
  DEBIT
  CREDIT
}

enum SystemRoleType {
  RESIDENT
  ADMIN
  TREASURER
  LEADER
  CUSTOM
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum EventParticipantRole {
  COMMITTEE
  ATTENDEE
  GUEST
}

enum FundRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentGatewayStatus {
  PENDING
  PAID
  FAILED
  EXPIRED
  REFUNDED
  CANCELLED
}

enum PaymentMethodCategory {
  VIRTUAL_ACCOUNT
  E_WALLET
  QRIS
  CREDIT_CARD
  CONVENIENCE_STORE
  MANUAL_TRANSFER
}
